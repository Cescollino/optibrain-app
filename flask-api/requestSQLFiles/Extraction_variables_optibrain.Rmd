---
title: "Extraction données par catégorie de monitorage de l'interface Optibrain"
author: "Marie-Jade Marcil"
date: "31-07-2023, 31 juillet 2023"
output: html_document
---

##  PIC, PPC, Licox, PVC, PAM, ETCO2, PaCO2, température; et pupilles ; Glycémie, INR, plaquettes ; position tête du lit ##

#Chargement des librairies
```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(DBI)
```


#Fonction de connection SQL
Ne JAMAIS enregistrer ses fichiers de mot de passe dans le script. Il faut y faire référence dans un fichier qui DOIT être dans son dossier personnel

```{r message=FALSE, warning=FALSE}
#Format: userName;password
mon_ficher_mot_de_passe_SQL = path.expand("~/mot_de_passe_SQL.txt")

# Ensure the use of a single connection throughout this file.
get_db_con <- (function() {
  conn_internal <- NULL
  return(
    function() {
      if(is.null(conn_internal) || ! DBI::dbIsValid(conn_internal)) {
      #Creation d'une connexion if not valid or existant
       conn_internal <<- dbConnect(RPostgres::Postgres(),
                 dbname = 'cathydb', 
                 host = 'spxp-app05',
                 port = 5432,
                 user = suppressMessages(readr::read_delim(mon_ficher_mot_de_passe_SQL, ';', col_names = F)$X1),
                 password = suppressMessages(readr::read_delim(mon_ficher_mot_de_passe_SQL, ';', col_names = F)$X2),
                 check_interrupts = TRUE)
      }
      return(conn_internal)
    }
  )      
})()

requete = function(sql){
  res = dbSendQuery(get_db_con(), sql)
  data = dbFetch(res)
  #Important de vider les résultats
  dbClearResult(res)
  return(data)
}

```


```{r}
conn<-get_db_con()
```


```{sql connection=conn}
SELECt encounterid
FROM D_encounter
WHERE lifetimenumber='2107336'
```

## 1.0 NEURO-MONITORING DATA

# 1.1 Pression de perfusion crannienne (PPC) 
```{sql connection=conn,output.var=ppc}

SELECT DISTINCT
	l.par AS variable
	, noadmsip
	,l.valnum AS value
	,l.horodate AT TIME ZONE 'America/Montreal' AS dateVariable
FROM  icca_htr l
WHERE l.par LIKE 'PPC'
AND l.horodate AT TIME ZONE 'America/Montreal' BETWEEN '2016-03-12 00:58:00' AND '2016-03-18 12:00:00'
AND noadmsip=3563
ORDER BY horodate AT TIME ZONE 'America/Montreal'

```

# 1.2 Pression intercrannienne moyenne (PICm)
```{sql connection=conn,output.var=picm}

SELECT DISTINCT
	l.par AS variable
	,noadmsip
	,l.valnum AS value
	,l.horodate AT TIME ZONE 'America/Montreal' AS dateVariable
FROM  icca_htr l
WHERE l.par LIKE 'PICm'
AND l.horodate AT TIME ZONE 'America/Montreal' BETWEEN '2016-03-12 00:58:00' AND '2016-03-18 12:00:00'
AND noadmsip=3563
ORDER BY horodate AT TIME ZONE 'America/Montreal'


```


# QUESTION  1                                  *** LEQUEL PRENDRE ? ***

# 1.3.1 Licox dans ICCA
```{sql connection=conn,output.var=licox_icca}

SELECT 
  CASE WHEN a.attributeid IN ('100600', --- Capteur pression autre.valeur de presssion 
                      '102514', '102235','102456','106828') THEN 'LICOX'
  END AS variable
  , a.encounterid AS noadmsip
  , a.valuenumber as value
  , a.unitofmeasure
  , a.chartTime AS datevariable
  
FROM PtTreatment a
WHERE a.attributeId IN ('100600', --- Capteur pression autre.valeur de presssion 
                      '102514', '102235','102456','106828')--- Capteur pression autre.Valeur pression
AND a.chartTime BETWEEN '2016-03-12 00:58:00' AND '2016-03-18 12:00:00' 
AND a.encounterid=3563
ORDER BY charttime

```

# 1.3.2 Licox continu : Pm 
```{sql connection=conn,output.var=licox_continu}

SELECT par AS variable, noadmsip, valnum AS value, horodate AT TIME ZONE 'America/Montreal' AS datevariable
FROM icca_htr
WHERE par LIKE 'Pm'
AND SOURCE LIKE 'MyPeriodicData'
AND noadmsip=3563
AND horodate AT TIME ZONE 'America/Montreal' BETWEEN '2016-03-12 00:58:00' AND '2016-03-18 12:00:00'
ORDER BY horodate
```

# 1.4 Pupilles Droite & Gauche
```{sql connection=conn,output.var=pupilles}

SELECT 
   CASE
      WHEN a.attributeID = 45611 THEN 'Pupille D'
		  WHEN a.attributeID = 62470 THEN 'Pupille G'
		END AS Variable
  	, a.encounterid AS noadmsip
  	, a.terseform AS value
  	, a.verboseForm
  	, a.chartTime AS datevariable 

FROM  PtAssessment a 
WHERE (a.attributeId IN (45611, 62470))
AND a.chartTime BETWEEN '2016-03-12 00:58:00' AND '2016-03-18 12:00:00' 
AND encounterid=3563
order by variable, chartTime
```

# CSV NEURO-MONITORING 
```{r}
write.csv(ppc,"~/sadcsip_partage/Interface/Marie-Jade/Monitoring/PPC.csv", row.names = TRUE)
write.csv(picm,"~/sadcsip_partage/Interface/Marie-Jade/Monitoring/PICm.csv", row.names = TRUE)
write.csv(licox_continu,"~/sadcsip_partage/Interface/Marie-Jade/Monitoring/Pm.csv", row.names = TRUE)
write.csv(licox_icca,"~/sadcsip_partage/Interface/Marie-Jade/Monitoring/LICOX.csv", row.names = TRUE)
write.csv(pupilles, "~/sadcsip_partage/Interface/Marie-Jade/Monitoring/pupilles.csv", row.names = TRUE)
```


## 2.0 CARDIO-RESPIRATORY DATA


# 2.1 Pression veineuse centrale (PVCm)
```{sql connection=conn,output.var=pvcm}

SELECT DISTINCT
	l.par AS variable
  ,noadmsip
	,l.valnum AS value
	,l.horodate AT TIME ZONE 'America/Montreal' AS dateVariable
FROM  icca_htr l
WHERE l.par LIKE 'PVCm'
AND l.horodate AT TIME ZONE 'America/Montreal' BETWEEN '2016-03-12 00:58:00' AND '2016-03-18 12:00:00'
AND noadmsip=3563
ORDER BY horodate AT TIME ZONE 'America/Montreal'
```

# 2.2.1 Pression artérielle moyenne (PAm) dans ICCA
```{sql connection=conn,output.var=pam}

SELECT DISTINCT
  l.par AS variable
  ,noadmsip
	,l.valnum AS value
	,l.horodate AT TIME ZONE 'America/Montreal' AS dateVariable
FROM  icca_htr l
WHERE l.par LIKE 'PAm'
AND l.horodate AT TIME ZONE 'America/Montreal' BETWEEN '2016-03-12 00:58:00' AND '2016-03-18 12:00:00'
AND noadmsip=3563
ORDER BY horodate AT TIME ZONE 'America/Montreal'
```

#  2.3 ETCO2 continu dans ICCA
```{sql connection=conn,output.var=etco2}

SELECT par AS variable, noadmsip, valnum AS value, horodate AT TIME ZONE 'America/Montreal' AS datevariable 
FROM icca_htr
WHERE par LIKE 'CO2fe'
AND noadmsip=3563
AND horodate AT TIME ZONE 'America/Montreal' BETWEEN '2016-03-12 00:58:00' AND '2016-03-18 12:00:00'
ORDER BY horodate AT TIME ZONE 'America/Montreal'
```

# 2.4 PaCO2
```{sql connection=conn,output.var=paco2}
SELECT DISTINCT 
       CASE 
          WHEN l.attributeId IN ('7824','51394','94660','95135') THEN 'PaCO2'
        END AS Variable
       , l.encounterid AS noadmsip
       , l.valuenumber AS value
       , l.chartTime AS datevariable
FROM  PtLabResult l 
WHERE l.attributeId IN ('7824','51394','94660','95135')
AND l.chartTime BETWEEN '2016-03-12 00:58:00' AND '2016-03-18 12:00:00' 
AND encounterid=3563
order by chartTime
```

# CSV CARDIO-RESPIRATORY 
```{r}
write.csv(pvcm,"~/sadcsip_partage/Interface/Marie-Jade/Monitoring/PVCm.csv", row.names = TRUE)
write.csv(pam,"~/sadcsip_partage/Interface/Marie-Jade/Monitoring/PAm.csv", row.names = TRUE)
write.csv(etco2,"~/sadcsip_partage/Interface/Marie-Jade/Monitoring/ETCO2.csv", row.names = TRUE)
write.csv(paco2, "~/sadcsip_partage/Interface/Marie-Jade/Monitoring/PaCO2.csv", row.names = TRUE)
```


## 3.0 LABORATORY MONITORING DATA

# 3.1 Glycémie
```{sql connection=conn,output.var=glycemie}

SELECT DISTINCT 
       CASE WHEN l.attributeId IN (14418, 69967, 102087) THEN 'Glycémie'---glucose, glucomètre ADBD, glycémie ADBD
        END AS Variable
       , l.encounterid AS noadmsip
       , l.valuenumber AS value
       , l.unitofmeasure 
       , l.chartTime AS datevariable
FROM  PtLabResult l 
WHERE l.attributeId IN ('14418', '69967', '102087')
AND l.chartTime BETWEEN '2016-03-12 00:58:00' AND '2016-03-18 12:00:00' 
AND encounterid=3563
order by chartTime
```

# 3.2 INR
```{sql connection=conn,output.var=inr}

SELECT DISTINCT 
       CASE WHEN l.attributeID IN ('76332') THEN 'INR'
        END AS Variable
       , l.encounterid AS noadmsip
       , l.valuenumber AS value
       , l.chartTime AS datevariable
FROM  PtLabResult l 
WHERE l.attributeId IN ('76332')
AND l.chartTime BETWEEN '2016-03-12 00:58:00' AND '2016-03-18 12:00:00' 
AND encounterid=3563
order by chartTime
```

# 3.3 Plaquettes 
```{sql connection=conn,output.var=plaquette}

SELECT DISTINCT 
       CASE  WHEN l.attributeID IN ('43515') THEN 'Plaquettes' ---.Plaquettes (10^9/L) unitofmeasure
        END AS Variable
       , l.encounterid AS noadmsip
       , l.valuenumber AS value
       , l.chartTime AS datevariable
FROM  PtLabResult l 
WHERE l.attributeId IN ('43515')
AND l.chartTime BETWEEN '2016-03-12 00:58:00' AND '2016-03-18 12:00:00' 
AND encounterid=3563
order by chartTime
```

# CSV LABORATORY MONITORING 
```{r}
write.csv(glycemie,"~/sadcsip_partage/Interface/Marie-Jade/Monitoring/Glycemie.csv", row.names = TRUE)
write.csv(inr,"~/sadcsip_partage/Interface/Marie-Jade/Monitoring/INR.csv", row.names = TRUE)
write.csv(plaquette, "~/sadcsip_partage/Interface/Marie-Jade/Monitoring/Plaquettes.csv", row.names = TRUE)
```



## 4.0 GENERAL SUPPORT DATA

# QUESTION  2                     *** Quel est le attribute id et dans quelle table ? ***

# 4.1 Alalgo Sédation
```{sql connection=conn,output.var=algo}


```

# QUESTION  3                     *** Quel est le attribute id et dans quelle table ? ***

# 4.2 Nutrition
```{sql connection=conn,output.var=nutrition}



```

# 4.3 Position tête de lit
```{sql connection=conn,output.var=position}
SELECT 
   CASE WHEN a.interventionID IN (9932,9914) AND a.verboseForm LIKE '%degrés' THEN 'Tête de lit'  
   END AS Variable
	, a.encounterid AS noadmsip
	, a.terseform AS value
	, a.chartTime AS datevariable 
FROM  PtAssessment a 
WHERE (a.interventionID= 9932 AND a.verboseForm LIKE '%degrés')
AND a.chartTime BETWEEN '2016-03-12 00:58:00' AND '2016-03-18 12:00:00' 
AND encounterid=3563
order by chartTime
```

# 4.4 Température 
```{sql connection=conn,output.var=temperature}
SELECT 
   CASE
      WHEN (a.interventionId='5831' AND a.attributeId='16219') THEN 'Température Manuelle'---  Temperature Manuelle
      WHEN (a.interventionId='4816' AND a.attributeId='30847') THEN 'Température Continue' ---   Temperature continue
    END AS Variable
	, a.encounterid AS noadmsip
	, a.terseform AS value
	, a.unitofmeasure 
	, a.chartTime AS datevariable 
FROM  PtAssessment a 
WHERE ((a.interventionId='5831' AND a.attributeId='16219') OR
		  (a.interventionId='4816' AND a.attributeId='30847'))
AND a.chartTime BETWEEN '2016-03-12 00:58:00' AND '2016-03-18 12:00:00' 
AND encounterid=3563
order by variable, chartTime
```

# CSV GENERAL SUPPORT MONITORING 
```{r}
write.csv(position,"~/sadcsip_partage/Interface/Marie-Jade/Monitoring/TeteLit.csv", row.names = TRUE)
write.csv(temperature, "~/sadcsip_partage/Interface/Marie-Jade/Monitoring/Temperature.csv", row.names = TRUE)
```


## GROUPED MONITORING DATA


# ETCO2, PAm, Position de Tête, Pupille D, Pupille G, PVC, Temp Continue, Temp manuelle
```{sql connection=conn,output.var=etco2}

SELECT 
   CASE
      WHEN a.attributeID = 45611 THEN 'Pupille D'
		  WHEN a.attributeID = 62470 THEN 'Pupille G'
		  WHEN a.interventionID IN (9932,9914) AND a.verboseForm LIKE '%degrés' THEN 'Position Tête'    --positionnement (Inf) dans assessment
		  WHEN a.attributeID IN (30522, 30525, 30526, 46054, 46057, 46058, 48925, 48928, 48930) THEN 'PAM'
		  WHEN a.interventionId IN ('7061','7062','7162','7290','7294') THEN 'PVC'
		  WHEN a.interventionID IN ('5832') THEN 'EtCO2'--- CO2 expiré ou EtCO2
		  WHEN (a.interventionId='5831' AND a.attributeId='16219') THEN 'Temp Manuelle'---  Temperature Manuelle
      WHEN (a.interventionId='4816' AND a.attributeId='30847') THEN 'Temp Continue' ---   Temperature continue
	END AS Variable
	, a.encounterid AS noadmsip
	, a.terseform AS value
	, a.unitofmeasure 
	, a.chartTime AS datevariable 
--INTO #Var_Assessment1
FROM  PtAssessment a 
WHERE ((a.attributeId IN (45611
		,62470
		,30522, 30525, 30526, 46054, 46057, 46058, 48925, 48928, 48930)) OR (a.interventionId IN (7061,7062,7162,7290,7294,5832)) OR 
		(a.interventionID= 9932 AND a.verboseForm LIKE '%degrés') OR
		(a.interventionId='5831' AND a.attributeId='16219') OR
		(a.interventionId='4816' AND a.attributeId='30847'))
AND a.chartTime BETWEEN '2016-03-12 00:58:00' AND '2016-03-18 12:00:00' 
AND encounterid=3563
order by variable
```

# Laboratory variables : Glycémie, INR, PAC02, Plaquettes
```{sql connection=conn,output.var=ktir}

SELECT DISTINCT 
       CASE 
          WHEN l.attributeId IN ('7824','51394','94660','95135') THEN 'PaCO2'
          WHEN l.attributeID IN ('43515') THEN 'Plaquettes' ---.Plaquettes (10^9/L)
          WHEN l.attributeID IN ('76332') THEN 'INR'
          WHEN l.attributeId IN (14418, 69967, 102087) THEN 'Glycémie'---glucose, glucomètre ADBD, glycémie ADBD
       END AS Variable
       , l.encounterid AS noadmsip
       , l.valuenumber AS value
       , l.unitofmeasure 
       , l.chartTime AS datevariable
--INTO #test
FROM  PtLabResult l 
WHERE l.attributeId IN ('7824','51394','94660','95135','43515','76332','14418', '69967', '102087')
AND l.chartTime BETWEEN '2016-03-12 00:58:00' AND '2016-03-18 12:00:00' 
AND encounterid=3563
order by variable
```

